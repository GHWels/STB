<!-- -*- coding: utf-8 -*- -->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartTastingBoard – Kunden verwalten</title>

    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/STB-180x180.png">
</head>

<body>

<header class="navbar">
    <div class="navbar-left">
        <img src="assets/STB-180x180.png" alt="SmartTastingBoard Logo" class="navbar-logo">
        <span class="navbar-title">SmartTastingBoard – Kunden</span>
    </div>
    <nav class="navbar-right">
        <ul class="nav-list">
            <li><a href="index.html">Start</a></li>
            <li><a href="kunde.html" class="active">Kunden</a></li>
            <li><a href="board.html">Board</a></li>
        </ul>
    </nav>
</header>

<div class="main-layout">

    <!-- Kundenliste links -->
    <div class="list-wrapper list-wrapper-kunden">
        <h2>Kunden-Liste</h2>

        <div class="list-head list-head-kunden" id="kundenHeader">
            <span data-col="website">WEB-Seite</span>
            <span data-col="name">Name</span>
            <span data-col="ort">Ort</span>
        </div>

        <ul id="kundenListe">
            <li>(Lade Kunden...)</li>
        </ul>

        <button id="btnNeuKunde" type="button" class="btn-new-item">Neuen Kunden anlegen</button>
    </div>

    <!-- Formular & NFC-Liste rechts -->
    <div class="form-wrapper">
        <h2>Kunde bearbeiten / anlegen</h2>
        <!-- Status-Anzeige für Aktionen (Speichern/Laden/Fehler) -->
        <div id="kundenStatus" class="status-bar" aria-live="polite" style="margin-bottom: 1rem;"></div>

        <form id="kundenForm">

            <!-- Adress- / Kontaktzeilen mit NFC-Spalte -->
            <div style="display:flex; gap:1rem; align-items:flex-start;">
                <div style="flex:1; display:grid; grid-template-columns: 1fr 1fr; gap:1rem;">
                <!-- Spalte 1: Adresse -->
                <div>
                    <p>
                        <label for="website"><strong>WEB-Seite:</strong></label>
                        <input type="url" id="website" placeholder="https://www.herbsthofer.at">
                    </p>
                    <p>
                        <label for="kundenName"><strong>Name:</strong></label>
                        <input type="text" id="kundenName" required>
                    </p>
                    <p>
                        <label for="strasse"><strong>Straße / Hausnummer:</strong></label>
                        <input type="text" id="strasse">
                    </p>

                    <p>
                        <label for="plz"><strong>PLZ:</strong></label>
                        <input type="text" id="plz">
                    </p>
                </div>

                <!-- Spalte 2: Kontakt -->
                <div class="kunde-column-with-border">
                    <p>
                        <label for="kurzName"><strong>Anzeigename / Kurzname:</strong></label>
                        <input type="text" id="kurzName" required>
                    </p>
                    <p>
                        <label for="telefon"><strong>Telefon:</strong></label>
                        <input type="tel" id="telefon">
                    </p>

                    <p>
                        <label for="email"><strong>E-Mail:</strong></label>
                        <input type="email" id="email">
                    </p>
                    <p>
                        <label for="ort"><strong>Ort:</strong></label>
                        <input type="text" id="ort">
                    </p>

                </div>
               
                <!-- Notizen über zwei Spalten unter Adresse/Land und Kontakt -->
                <div class="grid-span-two">
                    <p>
                        <label for="notizen"><strong>Notizen:</strong></label>
                        <textarea id="notizen" rows="5" placeholder="Besonderheiten, Kundeninfo..."></textarea>
                    </p>
                </div>

                
            </div>
                            <!-- Spalte 3: unabhängig von Spalten 1+2 -->
                <div style="flex:0 0 32%; min-width:280px;">
                    <!-- Spalte 3 -->
                    <p>
                        <label for="kundenDocId"><strong>ID (Firestore Dokument-ID):</strong></label>
                        <input type="text" id="kundenDocId" readonly placeholder="Wird nach Auswahl/Speichern angezeigt">
                    </p>
                </div>
            </div>

            <button type="submit" class="btn-save-customer">Kunde speichern</button>
        </form>
    </div>

</div>

<script type="module">
    // -*- coding: utf-8 -*-
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        getDocs,
        updateDoc,
        arrayUnion,
        arrayRemove,
        addDoc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    let db = null;
    let currentKundenId = null;

    async function main() {
        const status = document.getElementById("kundenStatus");
        const btnNeu = document.getElementById("btnNeuKunde");

        try {
            const firebaseConfig = await fetch("./config/firebaseConfig.json").then(r => r.json());
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);

            await loadKundenListe();
            status.textContent = "";

            const form = document.getElementById("kundenForm");
            form.addEventListener("submit", onSaveKunde);

            btnNeu.addEventListener("click", () => {
                clearForm();
                currentKundenId = null;
                status.textContent = "Neuer Kunde – bitte Daten eingeben.";
            });

            // Klick auf die ID kopiert sie in die Zwischenablage
            const idField = document.getElementById("kundenDocId");
            if (idField) {
                const copyId = async () => {
                    const val = idField.value.trim();
                    if (!val) return;
                    try {
                        await navigator.clipboard.writeText(val);
                        status.textContent = "Dokument-ID kopiert.";
                    } catch {
                        // Fallback: Text selektieren, Nutzer kann STRG+C drücken
                        idField.focus();
                        idField.select();
                        status.textContent = "Dokument-ID markiert – bitte STRG+C drücken.";
                    }
                };
                idField.addEventListener("click", copyId);
                const idLabel = document.querySelector("label[for='kundenDocId']");
                if (idLabel) idLabel.addEventListener("click", copyId);
            }

            // Boards-Funktionalität entfernt

            status.textContent = "";
        } catch (err) {
            console.error(err);
            status.textContent = "Fehler beim Initialisieren: " + (err.message ?? err);
        }
    }

    let kundenSort = { by: 'name', dir: 'asc' };

    function sortKunden(items) {
        const { by, dir } = kundenSort;
        const factor = dir === 'asc' ? 1 : -1;
        return items.sort((a, b) => {
            const va = (a[by] || '').toString().toLowerCase();
            const vb = (b[by] || '').toString().toLowerCase();
            return va.localeCompare(vb, 'de', { sensitivity: 'base' }) * factor;
        });
    }

    async function loadKundenListe() {
        const ul = document.getElementById("kundenListe");
        ul.innerHTML = "";
        const loadingLi = document.createElement("li");
        loadingLi.textContent = "(Lade Kunden...)";
        ul.appendChild(loadingLi);

        try {
            const snap = await getDocs(collection(db, "Kunden"));

            if (snap.empty) {
                ul.innerHTML = "";
                const li = document.createElement("li");
                li.textContent = "(Keine Kunden gefunden)";
                ul.appendChild(li);
                return;
            }

            ul.innerHTML = "";

            const items = [];
            snap.forEach(docSnap => {
                const data = docSnap.data();
                items.push({
                    id: docSnap.id,
                    website: (data.Website || '').toString(),
                    name: data.Name || '',
                    ort: data.Ort || ''
                });
            });

            sortKunden(items);

            items.forEach(({ id, website, name, ort }) => {
                const li = document.createElement("li");
                const row = document.createElement("div");
                row.className = "list-row";

                const colNr = document.createElement("span");
                colNr.className = "list-col-uid";
                if (website) {
                    const a = document.createElement("a");
                    a.href = website;
                    try {
                        const u = new URL(website);
                        const host = u.hostname.replace(/^www\./, "");
                        a.textContent = host;
                    } catch {
                        a.textContent = website;
                    }
                    a.target = "_blank";
                    a.rel = "noopener noreferrer";
                    a.addEventListener("click", ev => ev.stopPropagation());
                    colNr.appendChild(a);
                } else {
                    colNr.textContent = "—";
                }

                const colName = document.createElement("span");
                colName.className = "list-col-name";
                colName.textContent = name;

                const colOrt = document.createElement("span");
                colOrt.className = "list-col-firma";
                colOrt.textContent = ort;

                row.appendChild(colNr);
                row.appendChild(colName);
                row.appendChild(colOrt);
                li.appendChild(row);

                li.addEventListener("click", () => {
                    loadKundeInForm(id);
                });

                ul.appendChild(li);
            });

        } catch (err) {
            console.error("Fehler beim Laden der Kunden:", err);
            ul.innerHTML = "";
            const li = document.createElement("li");
            li.textContent = "(Fehler beim Laden der Kunden)";
            ul.appendChild(li);
        }
    }

    // Header click sorting
    const kundenHeader = document.getElementById('kundenHeader');
    if (kundenHeader) {
        kundenHeader.addEventListener('click', async (ev) => {
            const target = ev.target;
            if (!(target instanceof HTMLElement)) return;
            const col = target.dataset.col;
            if (!col) return;
            const keyMap = { website: 'website', name: 'name', ort: 'ort' };
            const byKey = keyMap[col];
            if (!byKey) return;
            if (kundenSort.by === byKey) {
                kundenSort.dir = kundenSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                kundenSort.by = byKey;
                kundenSort.dir = 'asc';
            }
            await loadKundenListe();
        });
    }

    async function loadKundeInForm(kundenId) {
        const status = document.getElementById("kundenStatus");

        try {
            const ref = doc(db, "Kunden", kundenId);
            const snap = await getDoc(ref);

            if (!snap.exists()) {
                status.textContent = "Kunde mit ID " + kundenId + " nicht gefunden.";
                return;
            }

            const data = snap.data();
            currentKundenId = kundenId;

            const idField = document.getElementById("kundenDocId");
            if (idField) idField.value = currentKundenId || "";
            document.getElementById("kundenName").value = data.Name || "";
            document.getElementById("kurzName").value   = (data.KurzName || "");
            document.getElementById("strasse").value    = data.Strasse || "";
            document.getElementById("plz").value        = data.PLZ || "";
            document.getElementById("ort").value        = data.Ort || "";
            document.getElementById("telefon").value    = data.Telefon || "";
            document.getElementById("email").value      = data.Email || "";
            document.getElementById("website").value    = data.Website || "";
            document.getElementById("notizen").value    = data.Notizen || "";

            // Notizen-Vorschau entfernt (nicht genutzt)

        } catch (err) {
            console.error(err);
            status.textContent = "Fehler beim Laden des Kunden: " + (err.message ?? err);
        }
    }

    function clearForm() {
        document.getElementById("kundenForm").reset();
        const idField = document.getElementById("kundenDocId");
        if (idField) idField.value = "";
    }

    // Boards-Liste entfernt

    // Board-Auswahl entfernt

    // Boards-Auswahl entfernt

    async function onSaveKunde(e) {
        e.preventDefault();
        const status = document.getElementById("kundenStatus");

        const kundenName = document.getElementById("kundenName").value.trim();
        const kurzName   = document.getElementById("kurzName").value.trim();
        const strasse    = document.getElementById("strasse").value.trim();
        const plz        = document.getElementById("plz").value.trim();
        const ort        = document.getElementById("ort").value.trim();
        const telefon    = document.getElementById("telefon").value.trim();
        const email      = document.getElementById("email").value.trim();
        const website    = document.getElementById("website").value.trim();
        const notizen    = document.getElementById("notizen").value.trim();

        // UID optional als Feld; Firestore vergibt die Dokument-ID
        if (!kundenName) {
            status.textContent = "Name darf nicht leer sein.";
            return;
        }

        // einfache Validierung: wenn Website gesetzt ist, muss sie eine gültige URL sein
        if (website) {
            try {
                // erlaubt relative Fehler früh zu erkennen
                const u = new URL(website);
                // optional: nur http/https zulassen
                if (u.protocol !== "http:" && u.protocol !== "https:") {
                    status.textContent = "WEB-Seite muss mit http(s) beginnen.";
                    return;
                }
            } catch {
                status.textContent = "Bitte eine gültige URL für die WEB-Seite angeben.";
                return;
            }
        }

        try {
            let kundenDocId = currentKundenId;

            const kundenData = {
                Name: kundenName,
                KurzName: kurzName || null,
                Strasse: strasse || null,
                PLZ: plz || null,
                Ort: ort || null,
                Telefon: telefon || null,
                Email: email || null,
                Website: website || null,
                Notizen: notizen || null
                // Boards bleibt unverändert
            };

            if (!kundenDocId) {
                const docRef = await addDoc(collection(db, "Kunden"), kundenData);
                kundenDocId = docRef.id;
            } else {
                const ref = doc(db, "Kunden", kundenDocId);
                await setDoc(ref, kundenData, { merge: true });
            }

            currentKundenId = kundenDocId;
            const idField = document.getElementById("kundenDocId");
            if (idField) idField.value = currentKundenId || "";

            await loadKundenListe();
            status.textContent = "Kunde gespeichert.";
            
            // Boards-Funktionalität entfernt
        } catch (err) {
            console.error(err);
            status.textContent = "Fehler beim Speichern: " + (err.message ?? err);
        }
    }

    // Boards-Liste entfernt

    // Boards-Hinzufügen/Entfernen entfernt

    main();
</script>

</body>
</html>
