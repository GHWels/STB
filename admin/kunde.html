<!-- -*- coding: utf-8 -*- -->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartTastingBoard – Kunden verwalten</title>

    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/STB-180x180.png">
</head>

<body>

<header class="navbar">
    <div class="navbar-left">
        <img src="assets/STB-180x180.png" alt="SmartTastingBoard Logo" class="navbar-logo">
        <span class="navbar-title">SmartTastingBoard – Kunden</span>
    </div>
    <nav class="navbar-right">
        <ul class="nav-list">
            <li><a href="index.html">Start</a></li>
            <li><a href="lieferant.html">Lieferanten</a></li>
            <li><a href="artikel.html">Artikel</a></li>
            <li><a href="kunde.html" class="active">Kunden</a></li>
            <li><a href="event.html">Events</a></li>
            <li><a href="board.html">Board</a></li>
            <li><a href="nfc_zuordnen.html">NFC zuordnen</a></li>
            <li><a href="kategorien.html">Kategorien</a></li>
        </ul>
    </nav>
</header>

<div class="main-layout">

    <!-- Kundenliste links -->
    <div class="list-wrapper list-wrapper-kunden">
        <h2>Kunden-Liste</h2>
        <div class="kunden-hint-row">
            <p class="hint">Klicke auf einen Kunden, um die Daten zu bearbeiten.</p>
            <span id="kundenStatus" class="hint"></span>
        </div>

        <div class="list-head list-head-kunden">
            <span>UID</span>
            <span>Name</span>
            <span>Ort</span>
        </div>

        <ul id="kundenListe">
            <li>(Lade Kunden...)</li>
        </ul>

        <button id="btnNeuKunde" type="button" class="btn-new-item">Neuen Kunden anlegen</button>
    </div>

    <!-- Formular & NFC-Liste rechts -->
    <div class="form-wrapper">
        <h2>Kunde bearbeiten / anlegen</h2>
        <!-- Status wird jetzt oben in der Kundenliste angezeigt -->

        <form id="kundenForm">

            <!-- obere Zeile: UID + Name + Boards -->
            <div class="form-grid-3">
                <div>
                    <p>
                        <label for="kundenUid"><strong>UID-Nr:</strong></label>
                        <input type="text" id="kundenUid" placeholder="z.B. ATU12345678" required class="input-full-width">
                    </p>
                </div>
                <div class="kunde-column-with-border">
                    <p>
                        <label for="kundenName"><strong>Name:</strong></label>
                        <input type="text" id="kundenName" required>
                    </p>
                </div>
                <div>
                    <h3>Boards dieses Kunden</h3>
                </div>
            </div>

            <!-- Adress- / Kontaktzeilen mit NFC-Spalte -->
            <div class="kunde-three-column">
                <!-- Spalte 1: Adresse -->
                <div>
                    <h3>Adresse</h3>

                    <p>
                        <label for="strasse"><strong>Straße / Hausnummer:</strong></label>
                        <input type="text" id="strasse">
                    </p>

                    <p>
                        <label for="plz"><strong>PLZ:</strong></label>
                        <input type="text" id="plz">
                    </p>

                    <p>
                        <label for="ort"><strong>Ort:</strong></label>
                        <input type="text" id="ort">
                    </p>

                    <p>
                        <label for="land"><strong>Land:</strong></label>
                        <input type="text" id="land" value="Österreich">
                    </p>
                </div>

                <!-- Spalte 2: Kontakt -->
                <div class="kunde-column-with-border">
                    <h3>Kontakt</h3>

                    <p>
                        <label for="telefon"><strong>Telefon:</strong></label>
                        <input type="tel" id="telefon">
                    </p>

                    <p>
                        <label for="email"><strong>E-Mail:</strong></label>
                        <input type="email" id="email">
                    </p>

                    <p>
                        <label for="website"><strong>WEB-Seite:</strong></label>
                        <input type="url" id="website" placeholder="https://www.herbsthofer.at">
                    </p>
                </div>

                <!-- Spalte 3: Boards -->
                <div class="kunde-nfc-column">

                    <p class="hint">
                        Hier kannst du Boards einem Kunden zuordnen.<br>
                        Klick auf ein Board in der Liste, um es wieder zu entfernen.
                    </p>

                    <div id="kundenBoardsContainer">
                        <table id="kundenBoardsListe">
                            <thead>
                                <tr>
                                    <th>Board-ID</th>
                                    <th>Anz. NFC</th>
                                    <th>Aktionen</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr><td colspan="3">(Noch kein Kunde ausgewählt)</td></tr>
                            </tbody>
                        </table>
                        <p>
                            <button type="button" id="btnAddBoard" disabled>Board hinzufügen</button>
                        </p>
                    </div>
                </div>
                
                <!-- Notizen über zwei Spalten unter Adresse/Land und Kontakt -->
                <div class="grid-span-two">
                    <p>
                        <label for="notizen"><strong>Notizen:</strong></label>
                        <textarea id="notizen" rows="5" placeholder="Besonderheiten, Kundeninfo..."></textarea>
                    </p>
                </div>
            </div>

            <button type="submit" class="btn-save-customer">Kunde speichern</button>
        </form>
    </div>

</div>

<script type="module">
    // -*- coding: utf-8 -*-
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        getDocs,
        updateDoc,
        arrayUnion,
        arrayRemove,
        addDoc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    let db = null;
    let currentKundenId = null;

    async function main() {
        const status = document.getElementById("kundenStatus");
        const btnNeu = document.getElementById("btnNeuKunde");
        const btnAddBoard = document.getElementById("btnAddBoard");

        try {
            const firebaseConfig = await fetch("./config/firebaseConfig.json").then(r => r.json());
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);

            await loadKundenListe();
            await loadAvailableBoards();

            const form = document.getElementById("kundenForm");
            form.addEventListener("submit", onSaveKunde);

            btnNeu.addEventListener("click", () => {
                clearForm();
                clearBoardsListe();
                disableBoardSelection();
                currentKundenId = null;
                status.textContent = "Neuer Kunde – bitte Daten eingeben.";
            });

            btnAddBoard.addEventListener("click", onAddBoard);

            status.textContent = "";
        } catch (err) {
            console.error(err);
            status.textContent = "Fehler beim Initialisieren: " + (err.message ?? err);
        }
    }

    async function loadKundenListe() {
        const ul = document.getElementById("kundenListe");
        ul.innerHTML = "";
        const loadingLi = document.createElement("li");
        loadingLi.textContent = "(Lade Kunden...)";
        ul.appendChild(loadingLi);

        try {
            const snap = await getDocs(collection(db, "Kunden"));

            if (snap.empty) {
                ul.innerHTML = "";
                const li = document.createElement("li");
                li.textContent = "(Keine Kunden gefunden)";
                ul.appendChild(li);
                return;
            }

            ul.innerHTML = "";

            snap.forEach(docSnap => {
                const data = docSnap.data();
                const uid = data.UID || docSnap.id;
                const name = data.Name || "";
                const ort  = data.Ort || "";

                const li = document.createElement("li");
                const row = document.createElement("div");
                row.className = "list-row";

                const colNr = document.createElement("span");
                colNr.className = "list-col-uid";
                colNr.textContent = uid;

                const colName = document.createElement("span");
                colName.className = "list-col-name";
                colName.textContent = name;

                const colOrt = document.createElement("span");
                colOrt.className = "list-col-firma";
                colOrt.textContent = ort;

                row.appendChild(colNr);
                row.appendChild(colName);
                row.appendChild(colOrt);
                li.appendChild(row);

                li.addEventListener("click", () => {
                    loadKundeInForm(docSnap.id);
                });

                ul.appendChild(li);
            });

        } catch (err) {
            console.error("Fehler beim Laden der Kunden:", err);
            ul.innerHTML = "";
            const li = document.createElement("li");
            li.textContent = "(Fehler beim Laden der Kunden)";
            ul.appendChild(li);
        }
    }

    async function loadKundeInForm(kundenId) {
        const status = document.getElementById("kundenStatus");

        try {
            const ref = doc(db, "Kunden", kundenId);
            const snap = await getDoc(ref);

            if (!snap.exists()) {
                status.textContent = "Kunde mit ID " + kundenId + " nicht gefunden.";
                clearBoardsListe();
                return;
            }

            const data = snap.data();
            currentKundenId = kundenId;

                const uidInput = document.getElementById("kundenUid");
                uidInput.value = data.UID || "";
                uidInput.readOnly = false;
            document.getElementById("kundenName").value = data.Name || "";
            document.getElementById("strasse").value    = data.Strasse || "";
            document.getElementById("plz").value        = data.PLZ || "";
            document.getElementById("ort").value        = data.Ort || "";
            document.getElementById("land").value       = data.Land || "";
            document.getElementById("telefon").value    = data.Telefon || "";
            document.getElementById("email").value      = data.Email || "";
            document.getElementById("website").value    = data.Website || "";
            document.getElementById("notizen").value    = data.Notizen || "";

            const notizenPreview = (data.Notizen || "").trim();
            if (notizenPreview) {
                const shortNote = notizenPreview.length > 120 ? (notizenPreview.slice(0, 120) + "…") : notizenPreview;
                status.textContent = "Kunde " + (data.Name || kundenId) + " geladen – Notizen: " + shortNote;
            } else {
                status.textContent = "Kunde " + (data.Name || kundenId) + " geladen.";
            }

            const boards = Array.isArray(data.Boards) ? data.Boards : [];
            renderBoardsListe(boards);
            
            // Board-Auswahl aktivieren
            enableBoardSelection();

        } catch (err) {
            console.error(err);
            status.textContent = "Fehler beim Laden des Kunden: " + (err.message ?? err);
            clearBoardsListe();
            disableBoardSelection();
        }
    }

    function clearForm() {
        document.getElementById("kundenForm").reset();
    }

    function clearBoardsListe() {
        const tbody = document.querySelector("#kundenBoardsListe tbody");
        tbody.innerHTML = "";
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "(Noch keine Boards zugeordnet)";
        tr.appendChild(td);
        tbody.appendChild(tr);
    }

    function enableBoardSelection() {
        document.getElementById("boardSelect").disabled = false;
        document.getElementById("btnAddBoard").disabled = false;
    }

    function disableBoardSelection() {
        document.getElementById("boardSelect").disabled = true;
        document.getElementById("btnAddBoard").disabled = true;
        document.getElementById("boardSelect").value = "";
    }

    async function loadAvailableBoards() {
        const select = document.getElementById("boardSelect");
        
        try {
            const snap = await getDocs(collection(db, "Boards"));
            
            snap.forEach(docSnap => {
                const data = docSnap.data();
                const boardId = data.BoardID || docSnap.id;
                
                const option = document.createElement("option");
                option.value = boardId;
                option.textContent = boardId;
                select.appendChild(option);
            });
        } catch (err) {
            console.error("Fehler beim Laden der Boards:", err);
        }
    }

    async function onSaveKunde(e) {
        e.preventDefault();
        const status = document.getElementById("kundenStatus");

        const kundenUid = document.getElementById("kundenUid").value.trim();
        const kundenName = document.getElementById("kundenName").value.trim();
        const strasse    = document.getElementById("strasse").value.trim();
        const plz        = document.getElementById("plz").value.trim();
        const ort        = document.getElementById("ort").value.trim();
        const land       = document.getElementById("land").value.trim();
        const telefon    = document.getElementById("telefon").value.trim();
        const email      = document.getElementById("email").value.trim();
        const website    = document.getElementById("website").value.trim();
        const notizen    = document.getElementById("notizen").value.trim();

        // UID optional als Feld; Firestore vergibt die Dokument-ID
        if (!kundenName) {
            status.textContent = "Name darf nicht leer sein.";
            return;
        }

        // einfache Validierung: wenn Website gesetzt ist, muss sie eine gültige URL sein
        if (website) {
            try {
                // erlaubt relative Fehler früh zu erkennen
                const u = new URL(website);
                // optional: nur http/https zulassen
                if (u.protocol !== "http:" && u.protocol !== "https:") {
                    status.textContent = "WEB-Seite muss mit http(s) beginnen.";
                    return;
                }
            } catch {
                status.textContent = "Bitte eine gültige URL für die WEB-Seite angeben.";
                return;
            }
        }

        try {
            status.textContent = "Speichere Kunde...";

            let kundenDocId = currentKundenId;

            const kundenData = {
                UID: kundenUid,
                Name: kundenName,
                Strasse: strasse || null,
                PLZ: plz || null,
                Ort: ort || null,
                Land: land || null,
                Telefon: telefon || null,
                Email: email || null,
                Website: website || null,
                Notizen: notizen || null
                // Boards bleibt unverändert
            };

            if (!kundenDocId) {
                const docRef = await addDoc(collection(db, "Kunden"), kundenData);
                kundenDocId = docRef.id;
            } else {
                const ref = doc(db, "Kunden", kundenDocId);
                await setDoc(ref, kundenData, { merge: true });
            }

            currentKundenId = kundenDocId;

            status.textContent = "Kunde erfolgreich gespeichert.";
            await loadKundenListe();
            
            // Board-Auswahl aktivieren, wenn Kunde gespeichert wurde
            enableBoardSelection();
        } catch (err) {
            console.error(err);
            status.textContent = "Fehler beim Speichern: " + (err.message ?? err);
        }
    }

    async function renderBoardsListe(boards) {
        const tbody = document.querySelector("#kundenBoardsListe tbody");
        tbody.innerHTML = "";

        if (!boards || boards.length === 0) {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 3;
            td.textContent = "(Noch keine Boards zugeordnet)";
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
        }

        // Board-Daten aus Firestore laden
        for (const boardId of boards) {
            const tr = document.createElement("tr");
            
            // Spalte 1: Board-ID
            const tdBoard = document.createElement("td");
            tdBoard.textContent = boardId;
            
            // Spalte 2: Anzahl NFC-Codes
            const tdNfcCount = document.createElement("td");
            tdNfcCount.className = "board-nfc-count";
            tdNfcCount.textContent = "...";
            
            // Board-Daten laden
            try {
                const boardRef = doc(db, "Boards", boardId);
                const boardSnap = await getDoc(boardRef);
                
                if (boardSnap.exists()) {
                    const boardData = boardSnap.data();
                    const nfcCodes = Array.isArray(boardData.NfcCodes) ? boardData.NfcCodes : [];
                    tdNfcCount.textContent = nfcCodes.length;
                } else {
                    tdNfcCount.textContent = "0";
                }
            } catch (err) {
                console.error("Fehler beim Laden der Board-Daten:", err);
                tdNfcCount.textContent = "?";
            }
            
            // Spalte 3: Buttons
            const tdButtons = document.createElement("td");
            tdButtons.className = "board-actions";
            
            const btnOpen = document.createElement("button");
            btnOpen.type = "button";
            btnOpen.textContent = "→";
            btnOpen.title = "Zum Board wechseln";
            btnOpen.className = "btn-board-action";
            btnOpen.addEventListener("click", (e) => {
                e.stopPropagation();
                window.location.href = `board.html`;
            });
            
            const btnRemove = document.createElement("button");
            btnRemove.type = "button";
            btnRemove.textContent = "✕";
            btnRemove.title = "Board entfernen";
            btnRemove.className = "btn-board-action";
            btnRemove.addEventListener("click", async (e) => {
                e.stopPropagation();
                await removeBoard(boardId);
            });
            
            tdButtons.appendChild(btnOpen);
            tdButtons.appendChild(btnRemove);
            
            tr.appendChild(tdBoard);
            tr.appendChild(tdNfcCount);
            tr.appendChild(tdButtons);
            tbody.appendChild(tr);
        }
    }

    async function onAddBoard() {
        const status = document.getElementById("kundenStatus");
        const boardSelect = document.getElementById("boardSelect");
        const boardId = boardSelect.value.trim();

        if (!currentKundenId) {
            status.textContent = "Bitte zuerst einen Kunden auswählen oder speichern.";
            return;
        }
        if (!boardId) {
            status.textContent = "Bitte ein Board auswählen.";
            return;
        }

        try {
            status.textContent = "Füge Board hinzu...";

            const refKunde = doc(db, "Kunden", currentKundenId);
            await updateDoc(refKunde, {
                Boards: arrayUnion(boardId)
            }).catch(async err => {
                if (err && err.code === "not-found") {
                    await setDoc(refKunde, { Boards: [boardId] }, { merge: true });
                } else {
                    throw err;
                }
            });

            // Liste neu laden
            const snap = await getDoc(refKunde);
            const data = snap.data();
            const boards = Array.isArray(data.Boards) ? data.Boards : [];
            renderBoardsListe(boards);

            boardSelect.value = "";
            status.textContent = "Board hinzugefügt.";
        } catch (err) {
            console.error(err);
            status.textContent = "Fehler beim Hinzufügen des Boards: " + (err.message ?? err);
        }
    }

    async function removeBoard(boardId) {
        const status = document.getElementById("kundenStatus");

        if (!currentKundenId) return;

        if (!confirm("Board \"" + boardId + "\" wirklich vom Kunden entfernen?")) {
            return;
        }

        try {
            status.textContent = "Entferne Board...";

            const refKunde = doc(db, "Kunden", currentKundenId);
            await updateDoc(refKunde, {
                Boards: arrayRemove(boardId)
            });

            // Liste neu laden
            const snap = await getDoc(refKunde);
            const data = snap.data();
            const boards = Array.isArray(data.Boards) ? data.Boards : [];
            renderBoardsListe(boards);

            status.textContent = "Board entfernt.";
        } catch (err) {
            console.error(err);
            status.textContent = "Fehler beim Entfernen des Boards: " + (err.message ?? err);
        }
    }

    main();
</script>

</body>
</html>
