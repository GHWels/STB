<!-- -*- coding: utf-8 -*- -->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>SmartTastingBoard – Artikel verwalten</title>

    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/STB-180x180.png">
</head>

<body>

<header class="navbar">
    <div class="navbar-left">
        <img src="assets/STB-180x180.png" alt="SmartTastingBoard Logo" class="navbar-logo">
        <span class="navbar-title">SmartTastingBoard – Artikel</span>
    </div>
    <nav class="navbar-right">
        <ul class="nav-list">
            <li><a href="index.html">Start</a></li>
            <li><a href="lieferant.html">Lieferanten</a></li>
            <li><a href="artikel.html" class="active">Artikel</a></li>
            <li><a href="kunde.html">Kunden</a></li>
            <li><a href="event.html">Events</a></li>
            <li><a href="board.html">Board</a></li>
            <li><a href="nfc_zuordnen.html">NFC zuordnen</a></li>
            <li><a href="kategorien.html">Kategorien</a></li>
        </ul>
    </nav>
</header>

<div class="main-layout">



    <!-- Artikel-Liste links -->
    <div class="list-wrapper list-wrapper-artikel">
        <h2>Artikel-Liste</h2>

        <!-- Zeile 1: Lieferant -->
        <div class="field-group">
            <label for="lieferantSelect"><strong>Lieferant:</strong></label>
            <select id="lieferantSelect">
                <option value="">-- bitte wählen --</option>
            </select>
        </div>


        <p class="hint">Klicke auf einen Artikel, um die Daten zu bearbeiten.</p>

        <div class="list-head list-head-artikel">
            <span>Jahrgang</span>
            <span>Sorte</span>
            <span>Bezeichnung</span>
            <span>ArtikelID</span>
        </div>

        <ul id="artikelListe">
            <li>(Lade Artikel...)</li>
        </ul>

        <button id="btnNeuArtikel" type="button" class="btn-new-item">Neuen Artikel anlegen</button>
    </div>

    <!-- Formular rechts -->
    <div class="form-wrapper form-wrapper-artikel">
        <h2>Artikel bearbeiten / anlegen</h2>

        <p id="status"></p>

        <form id="artikelForm">
            <!-- Zeile 2: ArtikelID (Spalte 1) + Firestore-Dokument-ID (Spalte 2) -->
            <div class="field-row-2 field-group">
                <p>
                    <label for="artikelId"><strong>ArtikelID:</strong></label>
                    <input type="text" id="artikelId" required>
                    <br>
                    <label for="eanCode"><strong>EAN-Code:</strong></label>
                    <input type="text" id="eanCode" placeholder="z.B. 9001234567890">
                </p>
                <p>
                    <label for="artikelDocId"><strong>ID (Firestore Dokument-ID):</strong></label>
                    <input type="text" id="artikelDocId" readonly placeholder="Wird nach Auswahl/Speichern angezeigt">
                </p>
            </div>

            <!-- Zeile 3: Kategorie + Sorte -->
            <div class="field-row-2 field-group">
                <p>
                    <label for="kategorieSelect"><strong>Kategorie:</strong></label>
                    <select id="kategorieSelect" required>
                        <option value="">-- Bitte wählen --</option>
                    </select>
                </p>
                <p>
                    <label for="sorteSelect"><strong>Sorte:</strong></label>
                    <select id="sorteSelect" required>
                        <option value="">-- Bitte wählen --</option>
                    </select>
                </p>
            </div>

            <!-- Zeile 4: Bezeichnung + Jahrgang -->
            <div class="field-row-2 field-group">
                <p class="grid-span-two">
                    <label for="bezeichnung"><strong>Bezeichnung:</strong></label>
                    <input type="text" id="bezeichnung" placeholder="z.B. Edelbrand">
                </p>
            </div>
            <div class="field-row-2 field-group">
                <p>
                    <label for="jahrgang"><strong>Jahrgang:</strong></label>
                    <input type="number" id="jahrgang" class="input-kategorie-width" placeholder="z.B. 2023" min="1900" max="2100" required>
                </p>
                <p class="vis-hidden">
                    <!-- Unsichtbares Element zur Spaltenausrichtung -->
                    <span></span>
                </p>
            </div>

            <!-- Zeile 5: EKP + VKP -->
            <!-- Zeile 6: Info und Beschreibung -->
            <div class="field-row-1 field-group">
                <p>
                    <label for="info"><strong>INFO:</strong></label>
                    <input type="text" id="info" placeholder="Kurze Info zum Artikel">
                </p>
            </div>
            <div class="field-row-1 field-group">
                <p>
                    <label for="beschreibung"><strong>Beschreibung:</strong></label>
                    <textarea id="beschreibung" rows="20" placeholder="Details zum Artikel"></textarea>
                </p>
            </div>

            <!-- Zeile 7: EKP + VKP (verschoben) -->
            <div class="field-row-2 field-group">
                <p>
                    <label for="ekp"><strong>EKP (Einkaufspreis):</strong></label>
                    <input type="number" step="0.01" id="ekp" placeholder="0.00">
                </p>
                <p>
                    <label for="vkp"><strong>VKP (Verkaufspreis):</strong></label>
                    <input type="number" step="0.01" id="vkp" placeholder="0.00">
                </p>
            </div>

            <button type="submit" class="btn-save-customer">Artikel speichern</button>
        </form>
    </div>

</div>

<script type="module">
            async function loadSorten(kategorieId) {
                const select = document.getElementById("sorteSelect");
                select.innerHTML = '<option value="">-- Bitte wählen --</option>';
                if (!kategorieId) return;
                try {
                    const ref = doc(db, "Kategorien", kategorieId);
                    const snap = await getDoc(ref);
                    if (snap.exists()) {
                        const data = snap.data();
                        const sorten = Array.isArray(data.Sorten) ? data.Sorten : [];
                        sorten.forEach(sorte => {
                            const option = document.createElement("option");
                            option.value = sorte;
                            option.textContent = sorte;
                            select.appendChild(option);
                        });
                    }
                } catch (err) {
                    console.error("Fehler beim Laden der Sorten:", err);
                }
            }
        async function loadKategorien() {
            const select = document.getElementById("kategorieSelect");
            select.innerHTML = '<option value="">-- Bitte wählen --</option>';
            try {
                const snap = await getDocs(collection(db, "Kategorien"));
                snap.forEach(docSnap => {
                    const data = docSnap.data();
                    const katId = docSnap.id;
                    const name = data.Name || katId;
                    const option = document.createElement("option");
                    option.value = katId;
                    option.textContent = name;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error("Fehler beim Laden der Kategorien:", err);
            }
        }
    // -*- coding: utf-8 -*- 
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
        getFirestore,
        doc,
        setDoc,
        getDocs,
        getDoc,
        collection,
        addDoc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    let db = null;
    let currentArtikelId = null;

    async function main() {
                document.getElementById("kategorieSelect").addEventListener("change", e => {
                    loadSorten(e.target.value);
                });
        const status = document.getElementById("status");
        const btnNeu = document.getElementById("btnNeuArtikel");

        try {
            const firebaseConfig = await fetch("./config/firebaseConfig.json").then(r => r.json());
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);

            await loadLieferanten();
            await loadArtikelListe();
            await loadKategorien();

            // Filter Artikelliste nach Lieferant
            const lieferantSelect = document.getElementById("lieferantSelect");
            if (lieferantSelect) {
                lieferantSelect.addEventListener("change", () => {
                    loadArtikelListe();
                });
            }

            const form = document.getElementById("artikelForm");
            form.addEventListener("submit", onSaveArtikel);

            btnNeu.addEventListener("click", () => {
                clearForm();
                currentArtikelId = null;
            });

        } catch (err) {
            console.error(err);
            status.textContent = "Fehler beim Initialisieren: " + (err.message ?? err);
        }
    }

    async function loadArtikelListe() {
        const ul = document.getElementById("artikelListe");
        ul.innerHTML = "";
        const loadingLi = document.createElement("li");
        loadingLi.textContent = "(Lade Artikel...)";
        ul.appendChild(loadingLi);

        try {
            const snap = await getDocs(collection(db, "Artikel"));

            if (snap.empty) {
                ul.innerHTML = "";
                const li = document.createElement("li");
                li.textContent = "(Keine Artikel gefunden)";
                ul.appendChild(li);
                return;
            }

            ul.innerHTML = "";

            // Filter nach Lieferant
            const lieferantSelect = document.getElementById("lieferantSelect");
            const filterValue = lieferantSelect ? lieferantSelect.value : "";

            // Wenn kein Lieferant gewählt, keine Artikel anzeigen
            if (!filterValue) {
                ul.innerHTML = "";
                return;
            }

            snap.forEach(docSnap => {
                const data = docSnap.data();
                const artikelId = data.ArtikelID || docSnap.id;
                const sorte = data.Sorte || "-";
                const bezeichnung = data.Bezeichnung || "-";
                const jahrgang = data.Jahrgang || "-";
                const lieferantID = data.LieferantID || "";

                if (lieferantID !== filterValue) return;

                const li = document.createElement("li");
                const row = document.createElement("div");
                row.className = "list-row";

                // Neue Reihenfolge: Jahrgang, Sorte, Bezeichnung, ArtikelID
                const colJahrgang = document.createElement("span");
                colJahrgang.className = "list-col-firma";
                colJahrgang.textContent = jahrgang;

                const colSorte = document.createElement("span");
                colSorte.className = "list-col-firma";
                colSorte.textContent = sorte;

                const colBezeichnung = document.createElement("span");
                colBezeichnung.className = "list-col-name";
                colBezeichnung.textContent = bezeichnung;

                const colArtikelId = document.createElement("span");
                colArtikelId.className = "list-col-name";
                colArtikelId.textContent = artikelId;

                row.appendChild(colJahrgang);
                row.appendChild(colSorte);
                row.appendChild(colBezeichnung);
                row.appendChild(colArtikelId);
                li.appendChild(row);

                li.addEventListener("click", () => {
                    loadArtikelInForm(docSnap.id);
                });

                ul.appendChild(li);
            });

        } catch (err) {
            console.error("Fehler beim Laden der Artikel:", err);
            ul.innerHTML = "";
            const li = document.createElement("li");
            li.textContent = "(Fehler beim Laden der Artikel)";
            ul.appendChild(li);
        }
    }

    async function loadArtikelInForm(artikelId) {
        const status = document.getElementById("status");

        try {
            const ref = doc(db, "Artikel", artikelId);
            const snap = await getDoc(ref);

            if (!snap.exists()) {
                status.textContent = "Artikel mit ID " + artikelId + " nicht gefunden.";
                return;
            }

            const data = snap.data();
            currentArtikelId = artikelId;

            const docIdEl = document.getElementById("artikelDocId");
            if (docIdEl) docIdEl.value = artikelId;

            document.getElementById("artikelId").value = data.ArtikelID || artikelId;
            document.getElementById("eanCode").value = data.EAN || "";
            document.getElementById("lieferantSelect").value = data.LieferantID || "";
            document.getElementById("ekp").value = data.EKP || "";
            document.getElementById("vkp").value = data.VKP || "";
            document.getElementById("jahrgang").value = data.Jahrgang || "";
            document.getElementById("kategorieSelect").value = data.Kategorie || "";
            await loadSorten(data.Kategorie || "");
            document.getElementById("sorteSelect").value = data.Sorte || "";
                document.getElementById("bezeichnung").value = data.Bezeichnung || "";
            document.getElementById("info").value = data.Info || "";
            document.getElementById("beschreibung").value = data.Beschreibung || "";

        } catch (err) {
            console.error(err);
            status.textContent = "Fehler beim Laden des Artikels: " + (err.message ?? err);
        }
    }

    function clearForm() {
        // Save Lieferant selection
        const lieferantValue = document.getElementById("lieferantSelect").value;
        document.getElementById("artikelForm").reset();
        document.getElementById("lieferantSelect").value = lieferantValue;
        const docIdEl = document.getElementById("artikelDocId");
        if (docIdEl) docIdEl.value = "";
    }

    async function loadLieferanten() {
        const select = document.getElementById("lieferantSelect");
        select.innerHTML = '<option value="">-- bitte wählen --</option>';

        try {
            const snap = await getDocs(collection(db, "Lieferanten"));

            if (snap.empty) {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "(keine Lieferanten gefunden)";
                select.appendChild(opt);
                return;
            }

            snap.forEach(docSnap => {
                const data = docSnap.data();
                const opt = document.createElement("option");
                opt.value = docSnap.id;
                opt.textContent = data.Name || docSnap.id;
                select.appendChild(opt);
            });
        } catch (err) {
            console.error("Lieferanten laden fehlgeschlagen", err);
        }
    }

    async function onSaveArtikel(e) {
        e.preventDefault();
        const status = document.getElementById("status");

        const artikelId = document.getElementById("artikelId").value.trim();
        const eanCode = document.getElementById("eanCode").value.trim();
        const ekp = document.getElementById("ekp").value;
        const vkp = document.getElementById("vkp").value;
        const jahrgang = document.getElementById("jahrgang").value.trim();
        const sorte = document.getElementById("sorteSelect").value;
        const kategorie = document.getElementById("kategorieSelect").value;
            const bezeichnung = document.getElementById("bezeichnung").value.trim();
        const info = document.getElementById("info").value.trim();
        const beschreibung = document.getElementById("beschreibung").value.trim();

        const sel = document.getElementById("lieferantSelect");
        const lieferantID = sel.value || null;
        const lieferantName = sel.selectedIndex > 0 ? sel.options[sel.selectedIndex].text : null;

        if (!artikelId) {
            status.textContent = "ArtikelID darf nicht leer sein.";
            return;
        }
        if (!jahrgang) {
            status.textContent = "Jahrgang ist ein Pflichtfeld.";
            return;
        }
        if (!kategorie) {
            status.textContent = "Kategorie ist ein Pflichtfeld.";
            return;
        }
        if (!sorte) {
            status.textContent = "Sorte ist ein Pflichtfeld.";
            return;
        }

        try {
            const artikelData = {
                ArtikelID: artikelId,
                EAN: eanCode || null,
                LieferantID: lieferantID,
                LieferantName: lieferantName,
                EKP: ekp ? Number(ekp) : null,
                VKP: vkp ? Number(vkp) : null,
                Jahrgang: jahrgang || null,
                Sorte: sorte || null,
                Kategorie: kategorie || null,
                Bezeichnung: bezeichnung || null,
                Info: info || null,
                Beschreibung: beschreibung || null
            };

            if (!currentArtikelId) {
                const docRef = await addDoc(collection(db, "Artikel"), artikelData);
                currentArtikelId = docRef.id;
                const docIdEl = document.getElementById("artikelDocId");
                if (docIdEl) docIdEl.value = currentArtikelId;
            } else {
                const ref = doc(db, "Artikel", currentArtikelId);
                await setDoc(ref, artikelData, { merge: true });
                const docIdEl = document.getElementById("artikelDocId");
                if (docIdEl) docIdEl.value = currentArtikelId;
            }

            await loadArtikelListe();
            clearForm();

        } catch (err) {
            console.error(err);
            status.textContent = "Fehler beim Speichern: " + (err.message ?? err);
        }
    }

    main();
</script>

</body>
</html>
