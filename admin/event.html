<!-- -*- coding: utf-8 -*- -->
<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SmartTastingBoard – Events verwalten</title>

    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/STB-180x180.png">
</head>

<body>

<header class="navbar">
    <div class="navbar-left">
        <img src="assets/STB-180x180.png" alt="SmartTastingBoard Logo" class="navbar-logo">
        <span class="navbar-title">SmartTastingBoard – Events</span>
    </div>
    <nav class="navbar-right">
        <ul class="nav-list">
            <li><a href="index.html">Start</a></li>
            <li><a href="lieferant.html">Lieferanten</a></li>
            <li><a href="artikel.html">Artikel</a></li>
            <li><a href="kunde.html">Kunden</a></li>
            <li><a href="board.html">Board</a></li>
            <li><a href="event.html" class="active">Events</a></li>
            <li><a href="nfc_zuordnen.html">NFC zuordnen</a></li>
            <li><a href="kategorien.html">Kategorien</a></li>
        </ul>
    </nav>
</header>

<div class="main-layout">

    <!-- Event-Liste links -->
    <div class="list-wrapper list-wrapper-events">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
            <h2 style="margin: 0;">Event-Liste</h2>
            
            <label style="display: inline-flex; align-items: center; gap: 0.5rem; white-space: nowrap;">
                <input type="checkbox" id="showOnlyFuture" checked>
                <strong>Nur zukünftige Events anzeigen</strong>
            </label>
        </div>

        <div class="list-head-3" id="eventHeader">
            <span data-col="datum">Datum</span>
            <span data-col="kunde">Kunde</span>
            <span data-col="eventname">Eventname</span>
        </div>

        <ul id="eventListe">
            <li>(Lade Events...)</li>
        </ul>

        <button id="btnNeuEvent" type="button" class="btn-new-item">Neues Event anlegen</button>
    </div>

    <!-- Formular rechts -->
    <div class="form-wrapper">
        <h2>Event bearbeiten / anlegen</h2>

        <p id="status"></p>

        <div class="form-two-col">
            <div class="form-col-1">
                <form id="eventForm">
                    <!-- Zeile 1: Kunde -->
                    <div class="field-row-1 field-group">
                        <p style="margin-top: 0;">
                            <label for="kundeAnzeige"><strong>Kunde:</strong></label>
                            <input type="text" id="kundeAnzeige" readonly placeholder="Wird automatisch aus Event-Liste übernommen">
                            <input type="hidden" id="kundenId">
                        </p>
                    </div>

                    <!-- Zeile 2: Datum -->
                    <div class="field-row-1 field-group">
                        <p>
                            <label for="eventDatum"><strong>Datum:</strong></label>
                            <input type="date" id="eventDatum" required>
                        </p>
                    </div>

                    <!-- Zeile 3: Eventname -->
                    <div class="field-row-1 field-group">
                        <p>
                            <label for="eventName"><strong>Eventname:</strong></label>
                            <input type="text" id="eventName" placeholder="z.B. Verkostung im Dezember" required>
                        </p>
                    </div>

                    <!-- Zeile 4: Kategorie -->
                    <div class="field-row-1 field-group">
                        <p>
                            <label for="kategorieSelect"><strong>Kategorie:</strong></label>
                            <select id="kategorieSelect" required>
                                <option value="">-- Bitte wählen --</option>
                            </select>
                        </p>
                    </div>

                    <!-- Zeile 5: Beschreibung -->
                    <div class="field-row-1 field-group">
                        <p>
                            <label for="beschreibung"><strong>Beschreibung:</strong></label>
                            <textarea id="beschreibung" rows="4" placeholder="Details zum Event"></textarea>
                        </p>
                    </div>

                    <button type="submit" class="btn-save-customer">Event speichern</button>
                </form>
            </div>
            <div class="form-col-2">
                <div class="field-row-1 field-group">
                    <p style="margin-top: 0;">
                        <label for="eventDocId"><strong>ID (Firestore Dokument-ID):</strong></label>
                        <input type="text" id="eventDocId" readonly placeholder="Wird nach Auswahl/Speichern angezeigt">
                    </p>
                </div>
                <section class="event-boards">
                    <h3>Boards im Event</h3>
                    <table id="eventBoardsTable">
                        <thead>
                            <tr>
                                <th>Board</th>
                                <th>Info</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="2">(Event noch nicht gespeichert)</td></tr>
                        </tbody>
                    </table>
                </section>
            </div>
        </div>
    </div>

</div>

<script type="module">
    // -*- coding: utf-8 -*-
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        collection,
        getDocs,
        addDoc,
        Timestamp,
        query,
        where
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    let db = null;

    async function main() {
        const status = document.getElementById("status");
        const btnNeu = document.getElementById("btnNeuEvent");

        try {
            const firebaseConfig = await fetch("./config/firebaseConfig.json").then(r => r.json());
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);

            await loadKategorien();
            await loadEventsListe();

            // Sorte wurde entfernt; keine Sorten-Nachladung mehr nötig

            const form = document.getElementById("eventForm");
            form.addEventListener("submit", onSaveEvent);

            btnNeu.addEventListener("click", () => {
                clearForm();
            });

            // Header click sorting
            const eventHeader = document.getElementById('eventHeader');
            if (eventHeader) {
                eventHeader.addEventListener('click', async (ev) => {
                    const target = ev.target;
                    if (!(target instanceof HTMLElement)) return;
                    const col = target.dataset.col;
                    if (!col) return;
                    const keyMap = { datum: 'datum', kunde: 'kunde', eventname: 'eventname' };
                    const byKey = keyMap[col];
                    if (!byKey) return;
                    if (eventSort.by === byKey) {
                        eventSort.dir = eventSort.dir === 'asc' ? 'desc' : 'asc';
                    } else {
                        eventSort.by = byKey;
                        eventSort.dir = 'asc';
                    }
                    await loadEventsListe();
                });
            }

            // Checkbox zum Filtern zukünftiger Events
            const showOnlyFutureCheckbox = document.getElementById('showOnlyFuture');
            if (showOnlyFutureCheckbox) {
                showOnlyFutureCheckbox.addEventListener('change', async () => {
                    await loadEventsListe();
                });
            }
        } catch (err) {
            console.error(err);
            status.textContent = "Fehler beim Initialisieren: " + (err.message ?? err);
        }
    }

    async function loadKategorien() {
        const select = document.getElementById("kategorieSelect");
        select.innerHTML = '<option value="">-- Bitte wählen --</option>';
        try {
            const snap = await getDocs(collection(db, "Kategorien"));
            snap.forEach(docSnap => {
                const data = docSnap.data();
                const katId = docSnap.id;
                const name = data.Name || katId;
                const option = document.createElement("option");
                option.value = katId;
                option.textContent = name;
                select.appendChild(option);
            });
        } catch (err) {
            console.error("Fehler beim Laden der Kategorien:", err);
        }
    }

    // Funktion loadSorten entfernt, da Feld "Sorte" entfernt wurde

    let eventSort = { by: 'datum', dir: 'asc' };

    function sortEvents(items) {
        const { by, dir } = eventSort;
        const factor = dir === 'asc' ? 1 : -1;
        return items.sort((a, b) => {
            let va, vb;
            if (by === 'datum') {
                va = a.datum || '';
                vb = b.datum || '';
            } else if (by === 'kunde') {
                va = (a.kundenName || '').toLowerCase();
                vb = (b.kundenName || '').toLowerCase();
            } else if (by === 'eventname') {
                va = (a.name || '').toLowerCase();
                vb = (b.name || '').toLowerCase();
            }
            return va.localeCompare(vb, 'de', { sensitivity: 'base' }) * factor;
        });
    }

    async function loadEventsListe() {
        const ul = document.getElementById("eventListe");
        ul.innerHTML = "";
        const loadingLi = document.createElement("li");
        loadingLi.textContent = "(Lade Events...)";
        ul.appendChild(loadingLi);

        try {
            const snap = await getDocs(collection(db, "Events"));
            const items = [];
            const showOnlyFuture = document.getElementById('showOnlyFuture')?.checked ?? true;
            const heute = new Date();
            heute.setHours(0, 0, 0, 0); // Heute um Mitternacht
            
            snap.forEach(docSnap => {
                const data = docSnap.data();
                const eventDatum = data.Datum || "";
                
                if (showOnlyFuture) {
                    // Nur zukünftige Events (heute oder später)
                    if (eventDatum) {
                        const eventDate = new Date(eventDatum);
                        if (eventDate >= heute) {
                            items.push({
                                id: docSnap.id,
                                datum: eventDatum,
                                name: data.EventName || "",
                                kundenName: data.KundenName || ""
                            });
                        }
                    }
                } else {
                    // Alle Events anzeigen
                    items.push({
                        id: docSnap.id,
                        datum: eventDatum,
                        name: data.EventName || "",
                        kundenName: data.KundenName || ""
                    });
                }
            });

            sortEvents(items);

            ul.innerHTML = "";
            items.forEach(({ id, datum, name, kundenName }) => {
                const li = document.createElement("li");
                const row = document.createElement("div");
                row.className = "list-row-3";

                const colDatum = document.createElement("span");
                colDatum.textContent = datum || "—";

                const colKunde = document.createElement("span");
                colKunde.textContent = kundenName || "—";

                const colEvent = document.createElement("span");
                colEvent.textContent = name || "—";

                row.appendChild(colDatum);
                row.appendChild(colKunde);
                row.appendChild(colEvent);
                li.appendChild(row);

                li.addEventListener("click", () => {
                    loadEventInForm(id);
                });

                ul.appendChild(li);
            });
        } catch (err) {
            console.error("Fehler beim Laden der Events:", err);
            ul.innerHTML = "";
            const li = document.createElement("li");
            li.textContent = "(Fehler beim Laden der Events)";
            ul.appendChild(li);
        }
    }

    async function loadEventInForm(eventId) {
        const status = document.getElementById("status");
        try {
            const ref = doc(db, "Events", eventId);
            const snap = await getDoc(ref);
            if (!snap.exists()) {
                status.textContent = "Event nicht gefunden.";
                return;
            }
            const data = snap.data();
            const form = document.getElementById("eventForm");
            form.setAttribute("data-docid", eventId);

            document.getElementById("eventName").value = data.EventName || "";
            document.getElementById("eventDatum").value = data.Datum || "";
            document.getElementById("kundeAnzeige").value = data.KundenName || "";
            document.getElementById("kundenId").value = data.KundenID || "";
            document.getElementById("kategorieSelect").value = data.KategorieID || "";
            document.getElementById("beschreibung").value = data.Beschreibung || "";
            document.getElementById("eventDocId").value = eventId;
            // Sorte entfernt: keine Nachladung/Belegung

            await loadBoardsForEvent(eventId);
        } catch (err) {
            console.error(err);
            status.textContent = "Fehler beim Laden des Events: " + (err.message ?? err);
        }
    }

    function clearForm() {
        const form = document.getElementById("eventForm");
        form.reset();
        form.removeAttribute("data-docid");
        document.getElementById("eventDocId").value = "";
        const tbody = document.querySelector("#eventBoardsTable tbody");
        if (tbody) tbody.innerHTML = '<tr><td colspan="2">(Event noch nicht gespeichert)</td></tr>';
    }

    async function onSaveEvent(e) {
        e.preventDefault();
        const status = document.getElementById("status");

        const eventName = document.getElementById("eventName").value.trim();
        const eventDatum = document.getElementById("eventDatum").value;
        const kundenId = document.getElementById("kundenId").value;
        const kundenName = document.getElementById("kundeAnzeige").value.trim();
        const kategorieId = document.getElementById("kategorieSelect").value;
        const beschreibung = document.getElementById("beschreibung").value.trim();
        // Sorte entfernt

        if (!eventName) { status.textContent = "Eventname ist ein Pflichtfeld."; return; }
        if (!kundenId) { status.textContent = "Kunde ist ein Pflichtfeld."; return; }
        if (!kategorieId) { status.textContent = "Kategorie ist ein Pflichtfeld."; return; }
        // Sorte entfernt
        if (!eventDatum) { status.textContent = "Datum ist ein Pflichtfeld."; return; }

        try {
            const dateObj = new Date(eventDatum);
            const data = {
                EventName: eventName,
                Datum: eventDatum,
                DatumTS: Timestamp.fromDate(dateObj),
                KundenID: kundenId,
                KundenName: kundenName,
                KategorieID: kategorieId,
                Beschreibung: beschreibung || null
            };

            const form = document.getElementById("eventForm");
            const docId = form.getAttribute("data-docid");

            if (!docId) {
                const docRef = await addDoc(collection(db, "Events"), data);
                form.setAttribute("data-docid", docRef.id);
                document.getElementById("eventDocId").value = docRef.id;
                await loadBoardsForEvent(docRef.id);
            } else {
                await setDoc(doc(db, "Events", docId), data, { merge: true });
                document.getElementById("eventDocId").value = docId;
                await loadBoardsForEvent(docId);
            }

            await loadEventsListe();
        } catch (err) {
            console.error(err);
            status.textContent = "Fehler beim Speichern: " + (err.message ?? err);
        }
    }

    async function loadBoardsForEvent(eventId) {
        const tbody = document.querySelector("#eventBoardsTable tbody");
        if (!tbody) return;
        if (!eventId) {
            tbody.innerHTML = '<tr><td colspan="2">(Event noch nicht gespeichert)</td></tr>';
            return;
        }

        tbody.innerHTML = '<tr><td colspan="2">(Lade Boards...)</td></tr>';
        try {
            const q = query(collection(db, "Boards"), where("EventID", "==", eventId));
            const snap = await getDocs(q);
            const rows = [];
            snap.forEach(docSnap => {
                const d = docSnap.data();
                rows.push({
                    id: docSnap.id,
                    name: d.Name || d.BoardName || null
                });
            });

            tbody.innerHTML = "";
            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="2">(Keine Boards gefunden)</td></tr>';
            } else {
                rows.forEach(r => {
                    const tr = document.createElement("tr");
                    const tdBoard = document.createElement("td");
                    tdBoard.textContent = r.name || r.id;
                    const tdInfo = document.createElement("td");
                    tdInfo.textContent = r.id;
                    tr.appendChild(tdBoard);
                    tr.appendChild(tdInfo);
                    tbody.appendChild(tr);
                });
            }
        } catch (err) {
            console.error("Fehler beim Laden der Boards:", err);
            tbody.innerHTML = '<tr><td colspan="2">(Fehler beim Laden der Boards)</td></tr>';
        }
    }

    main();
</script>

</body>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const label = Array.from(document.querySelectorAll('label'))
            .find(l => l.textContent && l.textContent.trim().startsWith('ID (Firestore Dokument-ID)'));
        if (!label) return;
        const forId = label.getAttribute('for');
        const input = forId ? document.getElementById(forId) : null;
        const copy = async () => {
            const val = input && input.value ? input.value.trim() : '';
            if (!val) return;
            try {
                await navigator.clipboard.writeText(val);
                const status = document.getElementById('eventStatus') || document.getElementById('kundenStatus');
                if (status) status.textContent = 'Dokument-ID kopiert.';
            } catch {
                if (input) { input.focus(); input.select(); }
                const status = document.getElementById('eventStatus') || document.getElementById('kundenStatus');
                if (status) status.textContent = 'Dokument-ID markiert – bitte STRG+C drücken.';
            }
        };
        label.addEventListener('click', copy);
        if (input) input.addEventListener('click', copy);
    });
</script>
</html>
